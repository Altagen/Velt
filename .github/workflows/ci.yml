name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Lint commit messages
  commitlint:
    name: ğŸ“ Commit Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install commitlint
        run: npm install -g @commitlint/cli @commitlint/config-conventional

      - name: Validate commits
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  # Frontend checks
  frontend:
    name: ğŸ¨ Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Install dependencies
        run: task ci:setup

      - name: Type check
        run: task check-ts

  # Rust checks
  rust:
    name: ğŸ¦€ Rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Check formatting and lint
        run: task check-rust

  # Security audit for npm
  npm-audit:
    name: ğŸ”’ NPM Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Install dependencies
        run: task ci:setup

      - name: Security audit
        run: task audit-npm
        continue-on-error: true

  # Security audit for Cargo
  cargo-audit:
    name: ğŸ”’ Cargo Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Security audit
        run: task audit-cargo

  # CodeQL analysis
  codeql:
    name: ğŸ›¡ï¸ CodeQL
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # SBOM generation
  sbom:
    name: ğŸ“¦ SBOM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate npm SBOM
        uses: CycloneDX/gh-node-module-generatebom@v1
        with:
          output: sbom-npm.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Generate Cargo SBOM
        run: task ci:sbom

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-npm.json
            sbom-cargo.json

  # Dependency review (PRs only)
  dependency-review:
    name: ğŸ” Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high

  # Test build on all platforms
  build-test:
    name: ğŸ”¨ Build Test (${{ matrix.name }})
    needs: [frontend, rust]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux x86_64
            platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            bundles: appimage,deb,rpm
          - name: macOS Intel
            platform: macos-latest
            target: x86_64-apple-darwin
            bundles: dmg
          - name: macOS ARM64
            platform: macos-latest
            target: aarch64-apple-darwin
            bundles: dmg

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install system dependencies (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Install npm dependencies
        run: task ci:setup

      - name: Build Tauri app
        run: task ci:build TARGET=${{ matrix.target }} BUNDLES=${{ matrix.bundles }}
